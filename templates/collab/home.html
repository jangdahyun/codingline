{% extends "base.html" %}
{% block title %}ë°© ëª©ë¡ Â· CodingLine{% endblock %}

{% block content %}

  <!-- ëª¨ë°”ì¼ ê²€ìƒ‰ -->
  <form action="{% url 'home' %}" method="get" class="md:hidden mb-4">
    <input name="q" value="{{ q }}" placeholder="ë°© ê²€ìƒ‰"
           class="border rounded px-3 py-2 w-full" />
  </form>

  <div class="grid md:grid-cols-3 gap-6">
    <!-- ì¢Œ: ë°© ìƒì„± -->
    <section class="md:col-span-1">
      <div class="bg-white border rounded-xl p-4">
        <h2 class="font-semibold mb-3">ìƒˆ ë°© ë§Œë“¤ê¸°</h2>
        <form action="{% url 'home' %}" method="post" class="space-y-3">
          {% csrf_token %}
          {{ form.non_field_errors }}
          <div>
            <label class="text-sm">ë°© ì œëª©</label>
              {{ form.Romname }}
              {{ form.Romname.errors }}
          </div>
          <div>
            <label class="text-sm">ì£¼ì œ</label>
            {{ form.topic}}
            {{ form.topic.errors }}
          </div>
          <div>
            <label class="text-sm">ì•”í˜¸</label>
            {{ form.password}}
            {{ form.password.errors }}
          </div>
          <div class="flex items-center gap-2">
            {{ form.is_private }} <span>ë¹„ê³µê°œ</span>
          </div>
          <div>
            <label class="text-sm">ì •ì›</label>
            {{ form.capacity}}
            {{ form.capacity.errors }}
          </div>
          <button class="bg-blue-600 text-white px-4 py-2 rounded w-full">
            ë§Œë“¤ê¸°
          </button>
        </form>
      </div>
    </section>

    <!-- ìš°: ë°© ëª©ë¡ -->
    <section class="md:col-span-2">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">ë°© ëª©ë¡</h2>
        {% if q %}<span class="text-sm text-gray-500">â€œ{{ q }}â€ ê²€ìƒ‰ ê²°ê³¼</span>{% endif %}
      </div>

      <ul class="space-y-3">
        {% for r in rooms %}
          {% if not r.is_private or q%}
            <li class="bg-white border rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="font-medium">{{ r.Romname }}</div>
                <div class="text-sm text-gray-500">
                  ì£¼ì œ: {{ r.topic }} Â· ìƒì„±: {{ r.created_at|date:"Y-m-d H:i" }} 
                  Â· ë°©ì¥: {{ r.created_by.display_name|default:r.created_by.username}}
                  {% if r.password%}Â· ğŸ”’ {% endif %}
                  {% if r.is_private%}Â· (ë¹„ê³µê°œ) {% endif %}
                </div>
              </div>
              <a href="{% url 'room-detail' r.slug %}"
                class="text-blue-600 enter-btn"                 {# JSê°€ ë¶™ì„ í´ë˜ìŠ¤ #}
                data-slug="{{ r.slug }}"                         {# ì–´ë–¤ ë°©ì¸ì§€ ì‹ë³„(ë·° URL ë§Œë“¤ ë•Œ ì‚¬ìš©) #}
                {% if r.password %}data-locked="1"{% endif %}    {# ë¹„ë²ˆì´ ìˆìœ¼ë©´ ì ê¸ˆ í”Œë˜ê·¸ #}
                >ì…ì¥
              </a>
            </li>
          {%endif%}
        {% empty %}
          <li class="text-gray-500">í‘œì‹œí•  ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</li>
        {% endfor %}
      </ul>
      <!-- ë°°ë„ˆ -->
      <div id="pwBanner" class="fixed left-0 right-0 bottom-4 mx-auto w-[min(720px,calc(100%-16px))]
                              hidden z-50">
        <div class="bg-white border rounded-xl shadow p-4">
          <div class="flex items-center gap-3">
            <strong id="pwBannerTitle" class="shrink-0">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</strong>
            <input id="pwBannerInput" type="password" class="border rounded px-3 py-2 w-full"
                  placeholder="ë°© ë¹„ë°€ë²ˆí˜¸" />
            <button id="pwBannerSubmit" class="bg-blue-600 text-white px-4 py-2 rounded">ì…ì¥</button>
            <button id="pwBannerClose"  class="px-3 py-2 rounded border">ë‹«ê¸°</button>
          </div>
          <p id="pwBannerErr" class="text-red-600 text-sm mt-2 hidden"></p>
        </div>
      </div>


    </section>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const IS_AUTH   = {{ request.user.is_authenticated|yesno:"true,false" }};  // true/false
  const LOGIN_URL = "{% url 'account_login' %}";
  (() => {
    'use strict';                                      // ì—„ê²© ëª¨ë“œ(ì‹¤ìˆ˜ ë¹¨ë¦¬ ë°œê²¬)

  //  ìƒíƒœ
  let current = { slug: null, href: null, enterUrl: null };

  const banner = document.getElementById('pwBanner');
  const el = {
    title:  document.getElementById('pwBannerTitle'),
    input:  document.getElementById('pwBannerInput'),
    err:    document.getElementById('pwBannerErr'),
    submit: document.getElementById('pwBannerSubmit'),
    close:  document.getElementById('pwBannerClose'),
  };

  // CSRF í† í° ì–»ê¸° (í˜ì´ì§€ ì–´ë”˜ê°€ì˜ csrf inputì„ ì‚¬ìš©)
  function getCsrfToken() {
    //  ë°°ë„ˆì— í¼ì´ ì—†ìœ¼ë¯€ë¡œ, í˜ì´ì§€ì— ì¡´ì¬í•˜ëŠ” ì²« csrf inputì„ ì°¾ìŠµë‹ˆë‹¤.
    const x = document.querySelector('input[name=csrfmiddlewaretoken]');
    if (x && x.value) return x.value;

    // ì¿ í‚¤ fallback (Django ê¸°ë³¸ ì¿ í‚¤ ì´ë¦„: csrftoken)
    const m = document.cookie.match(/(?:^|;\s*)csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : '';
  }


  // ë°°ë„ˆ ì—´ê¸°/ë‹«ê¸°
  function openBanner({ slug, title, href, enterUrl }) {
   current = { slug, href, enterUrl };
    el.title.textContent = title ? `ë¹„ë°€ë²ˆí˜¸: ${title}` : 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥';
    el.err.classList.add('hidden');
    el.input.value = '';
    banner.classList.remove('hidden');
    setTimeout(() => el.input.focus(), 0);
  }
  function closeBanner() {
    banner.classList.add('hidden');
    current = { slug: null, href: null, enterUrl: null };
  }

  // â€œì…ì¥â€ í´ë¦­ ê°€ë¡œì±„ê¸°: ë¹„ë²ˆ ìˆìœ¼ë©´ ì´ë™ ë§‰ê³  ë°°ë„ˆ ì˜¤í”ˆ
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('a.enter-btn');
    if (!btn) return;

    if (!IS_AUTH) {
      e.preventDefault();
      const nextTarget = btn.getAttribute('href'); // â† í´ë¦­í•œ ë§í¬ë¡œ ëŒì•„ê°€ê²Œ
      window.location.href = `${LOGIN_URL}?next=${encodeURIComponent(nextTarget)}`;
      return;
    }

    const locked = btn.hasAttribute('data-locked');
    if (!locked) return; // ë¹„ë²ˆ ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë™

    e.preventDefault();
    const slug     = btn.dataset.slug;
    const title    = btn.closest('li')?.querySelector('.font-medium')?.textContent?.trim() || '';
    const href     = btn.getAttribute('href');
    const enterUrl = btn.dataset.enterUrl || `/rooms/${slug}/enter/`; // â† ê°€ëŠ¥í•˜ë©´ data-enter-url ì“°ê¸°

    openBanner({ slug, title, href, enterUrl });
  });
  // ë°°ë„ˆ ë‹«ê¸°
  el.close.addEventListener('click', closeBanner);

  // ì œì¶œ ë¡œì§
  async function submitPassword() {
    if (!current.slug) return;

    el.err.classList.add('hidden');
    el.submit.disabled = true;

    const csrf = getCsrfToken();
    const pw   = el.input.value.trim();

    try {
      const res = await fetch(current.enterUrl, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrf,
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        },
        body: new URLSearchParams({ password: pw }),
      });

      const data = await res.json().catch(() => ({}));
      if (res.ok && data.ok) {
        closeBanner();
        window.location.href = data.next || current.href || `/rooms/${current.slug}/`;
      } else {
        el.err.textContent = data.error || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        el.err.classList.remove('hidden');
        el.input.focus(); el.input.select();
      }
    } catch (err) {
      console.error(err);
      el.err.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      el.err.classList.remove('hidden');
    } finally {
      el.submit.disabled = false;
    }
  }

  el.submit.addEventListener('click', submitPassword);

  // UX: Enterë¡œ ì œì¶œ, Escë¡œ ë‹«ê¸°, ë°°ë„ˆ ë°– í´ë¦­ ì‹œ ë‹«ê¸°
  el.input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter')  submitPassword();
    if (e.key === 'Escape') closeBanner();
  });
  document.addEventListener('click', (e) => {
    if (!banner.classList.contains('hidden') &&
        !e.target.closest('#pwBanner') &&
        !e.target.closest('a.enter-btn')) {
      closeBanner();
    }
  });
})();
</script>
{% endblock %}