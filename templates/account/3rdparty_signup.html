{# templates/account/3rdparty_signup.html #}
{% extends "base.html" %}
{% load i18n static %}
{% block content %}
<div class="container mx-auto max-w-xl py-8">
  {% static 'profile/basic.jpg' as default_avatar %}

  {% if not sociallogin %}
    <h1 class="text-xl font-bold mb-3">ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆì–´ìš”</h1>
    <p class="mb-4">ì†Œì…œ ë¡œê·¸ì¸ë¶€í„° ë‹¤ì‹œ ì§„í–‰í•´ ì£¼ì„¸ìš”.</p>
    <a class="px-4 py-2 rounded bg-black text-white" href="{% url 'account_login' %}">ë¡œê·¸ì¸ìœ¼ë¡œ</a>
  {% else %}

    {% with provider=sociallogin.account.provider|default:sociallogin.account.get_provider.name|lower data=sociallogin.account.extra_data %}
      {{ data|json_script:"sl-extra" }}
      {% comment %} <div class="text-xs text-gray-500 mb-2">
        provider = {{ provider|default:"(empty)" }}
      </div> {% endcomment %}


      {% if provider|slice:":5" == 'ì¹´ì¹´ì˜¤' %}
        <h1 class="text-2xl font-bold mb-4">ì¹´ì¹´ì˜¤ ê³„ì •ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ ì…ë ¥</h1>
      {% elif provider|slice:":5" == 'naver' %}
        <h1 class="text-2xl font-bold mb-4">ë„¤ì´ë²„ ê³„ì •ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ ì…ë ¥</h1>
      {% else %}
        <h1 class="text-2xl font-bold mb-4">ì†Œì…œ ê³„ì •ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ ì…ë ¥</h1>
      {% endif %}

      <div class="rounded border p-4 mb-6">
        <h2 class="font-semibold mb-3">ì†Œì…œì—ì„œ ê°€ì ¸ì˜¨ í”„ë¡œí•„</h2>

        {% if provider|slice:":5" == 'ì¹´ì¹´ì˜¤' %}
          {% with profile=data.kakao_account.profile props=data.properties %}
            <p class="mb-1">ë‹‰ë„¤ì„: <strong>{{ profile.nickname|default:props.nickname }}</strong></p>
            <p class="text-sm text-gray-500">ì¹´ì¹´ì˜¤ëŠ” ë‹‰ë„¤ì„/ì´ë¯¸ì§€ë§Œ ì €ì¥í•©ë‹ˆë‹¤.</p>
          {% endwith %}

        {% elif provider|slice:":5" == 'naver' %}
          {% with resp=data %}
            {{ resp|json_script:"naver-resp" }}
            <script>
              // ğŸ” ë„¤ì´ë²„ ì›ë³¸ ì‘ë‹µ ì½˜ì†”
              try {
                const resp = JSON.parse(document.getElementById('naver-resp').textContent);
                console.log('[3rdparty_signup][naver] resp:', resp);
              } catch (e) { console.warn('naver-resp parse fail', e); }
            </script>
            <p class="mb-1">ì‚¬ìš©ìëª…: <strong>{{ resp.name}}</strong></p>
            <p class="mb-1">ë‹‰ë„¤ì„: <strong>{{ resp.nickname}}</strong></p>
            {% if resp.email %}<p class="mb-1">ì´ë©”ì¼: <strong>{{ resp.email }}</strong></p>{% endif %}
            {% if resp.birthyear and resp.birthday %}
              <p class="mb-1">ìƒì¼: <strong>{{ resp.birthyear }}-{{ resp.birthday }}</strong></p>
            {% endif %}
            {% if resp.mobile %}
              <p class="mb-1">íœ´ëŒ€í°: <strong>{{ resp.mobile }}</strong></p>
            {% endif %}
            <p class="text-sm text-gray-500">ë„¤ì´ë²„ ì •ë³´ëŠ” ë™ì˜ ë²”ìœ„ ë‚´ì—ì„œ, íšŒì›ì •ë³´ì— ë¹„ì–´ìˆì„ ë•Œë§Œ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</p>
          {% endwith %}
        {% else %}
          <p class="text-sm text-gray-500">ì§€ì›ë˜ì§€ ì•Šì€ í”„ë¡œë°”ì´ë” í˜•ì‹ì…ë‹ˆë‹¤.</p>
        {% endif %}
      </div>

      {# âœ… í¼: ë°˜ë“œì‹œ socialaccount_signupë¡œ ë³´ëƒ„ #}
      <form id="social-signup-form" method="post" action="{% url 'socialaccount_signup' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <p data-required-warning class="hidden text-sm text-red-600 mb-3"></p>

        <div class="mb-6" data-avatar-field>
          <label for="id_avatar" class="block font-medium mb-2">í”„ë¡œí•„ ì´ë¯¸ì§€</label>
          {% with preview_src=social_avatar_url|default:default_avatar %}
            <div class="flex items-center gap-4 mb-2">
              <img src="{{ preview_src }}" alt="í”„ë¡œí•„ ë¯¸ë¦¬ë³´ê¸°"
                   class="porfile"
                   data-avatar-preview data-default-src="{{ preview_src }}" style="width:72px;height:72px;border-radius:9999px;object-fit:cover;border:1px solid #e5e7eb;">
              {{ form.avatar }}
            </div>
          {% endwith %}
          {% if form.avatar.errors %}
            <p class="text-sm text-red-600">{{ form.avatar.errors|striptags }}</p>
          {% endif %}
          <p class="text-xs text-gray-500">
            ì†Œì…œì—ì„œ ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë©°, ë‹¤ë¥¸ ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ êµì²´í•  ìˆ˜ ìˆì–´ìš”.
          </p>
        </div>

        <div class="mb-4">
          {{ form.username.label_tag }}<br>
          {{ form.username }}                  {# â† username ì•ˆ ë‚´ë³´ë‚´ë©´ ê²€ì¦ì— ë§‰í˜ #}
          {{ form.username.errors }}
        </div>
        <ul class="text-xs bg-gray-50 p-2 rounded mb-3">
        
        </ul>
        <div class="mb-4">
          {{ form.nickname.label_tag }}<br>
          {{ form.nickname }}                {# â† ë‹‰ë„¤ì„ ìˆ˜ì •/ì €ì¥ #}
          {{ form.nickname.errors }}
        </div>

        <div class="mb-6">
          {{ form.email.label_tag }}<br>
          {{ form.email }}
          {{ form.email.errors }}
          <p class="text-xs text-gray-500 mt-1">
            {% if provider|slice:":5" == 'naver' %}
              ë„¤ì´ë²„ ë™ì˜ë¡œ ì´ë©”ì¼ì´ ì „ë‹¬ë˜ë©´, íšŒì›ì •ë³´ê°€ ë¹„ì–´ìˆì„ ë•Œ ìë™ ì €ì¥ë©ë‹ˆë‹¤.
            {% else %}
              í•„ìš” ì‹œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.
            {% endif %}
          </p>
        </div>

        <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              {{ form.phone_number.label_tag }}<br>
              {{ form.phone_number }}
              {{ form.phone_number.errors }}
            </div>

            <div>
              {{ form.birth_date.label_tag }}<br>
              {{ form.birth_date }}
              {{ form.birth_date.errors }}
            </div>
        </div>

        <button type="submit" class="px-4 py-2 rounded bg-black text-white">ê°€ì… ì™„ë£Œ</button>
        
      </form>

    {% endwith %}

    <div class="mt-4">
      <a href="{% url 'account_login' %}" class="text-sm text-gray-600">ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ë¡œê·¸ì¸</a>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'js/avatar-preview.js' %}?v={% now 'U' %}"></script>
{% endblock %}
